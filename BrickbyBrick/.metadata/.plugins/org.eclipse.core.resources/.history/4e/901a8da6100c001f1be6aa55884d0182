package Pages;

import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.control.ListView;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;
import javafx.scene.layout.BorderPane;
import javafx.stage.Stage;
import javafx.scene.input.MouseEvent;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.time.LocalDate;
import java.util.stream.Stream;

public class ExpiredWarrantyAsset {
    private final VBox root;
    private final HBox buttons;
    private final ListView<String> listView; // To display assets with expired warranties

    public ExpiredWarrantyAsset() {
        root = new VBox(20);
        buttons = new HBox(20);
        listView = new ListView<>();

        buttons.setStyle("-fx-padding: 10px;");
        root.setStyle("-fx-background-color: cornflowerblue;"); // changes the color of the background

        Label expiredAssetLbl = new Label("Asset(s) with expired warranty");
        expiredAssetLbl.setStyle("-fx-font-size: 24px;"); // Change the font size

        Button homeButton = new Button("Return to Homepage");

        homeButton.setOnAction(e -> {
            Stage primaryStage = (Stage) homeButton.getScene().getWindow();
            HomeScreen homeScreen = new HomeScreen(primaryStage);
            primaryStage.setScene(new Scene(homeScreen.getRoot(), 800, 800));
            primaryStage.setTitle("Home Page");
        });

        buttons.getChildren().addAll(homeButton);
        root.getChildren().addAll(expiredAssetLbl, buttons, listView);

        listView.setOnMouseClicked(event -> {
            if (event.getClickCount() == 2 && !listView.getItems().isEmpty()) {
                String selectedItem = listView.getSelectionModel().getSelectedItem();
                displayAssetDetails(selectedItem);
            }
        });

        loadExpiredWarranties();
    }

    private void displayAssetDetails(String assetDetails) {
        Stage detailsStage = new Stage();
        detailsStage.setTitle("Asset Details");

        BorderPane detailsPane = new BorderPane();
        Label detailsLabel = new Label(assetDetails);
        detailsPane.setCenter(detailsLabel);

        Scene scene = new Scene(detailsPane, 300, 200);
        detailsStage.setScene(scene);
        detailsStage.show();
    }

    private void loadExpiredWarranties() {
        try (Stream<String> stream = Files.lines(Paths.get("asset_data.csv"))) {
            LocalDate today = LocalDate.now();
            stream.map(line -> line.split(","))
                  .filter(values -> LocalDate.parse(values[6]).isBefore(today))
                  .map(values -> String.join(", ", values))
                  .forEach(listView.getItems()::add);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public Parent getRoot() {
        return root;
    }
}
